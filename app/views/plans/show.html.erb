<div class="box">
  <div class="show-title">
    <h1><%= @plan.title || "Untitled Plan" %></h1>
  </div>

  <div class="division-show">
    <h2>Event Details</h2>
    <div class="row">
      <div class="col-md-6">
        <p><strong>Theme:</strong> <%= @plan.theme %></p>
        <p><strong>Number of Persons:</strong> <%= @plan.number_persons %></p>
        <p><strong>City:</strong> <%= @plan.city %></p>
      </div>
      <div class="col-md-6">
        <p><strong>Duration:</strong> <%= @plan.event_lenght %></p>
        <p><strong>Date:</strong> <%= @plan.roadmap_date&.strftime("%B %d, %Y") || "Not set" %></p>
        <% if @plan.pricing.present? %>
          <p><strong>Price Range:</strong> <%= @plan.pricing %></p>
        <% end %>
      </div>
    </div>
    <% if @plan.context.present? %>
      <p><strong>Context:</strong> <%= @plan.context %></p>
    <% end %>
  </div>

  <% if @plan.roadmap.present? %>
    <% begin %>
      <% roadmap_data = JSON.parse(@plan.roadmap) %>
      <% if roadmap_data && roadmap_data["roadmap"].is_a?(Array) %>
        <div class="division-show">
          <h2>Your Roadmap</h2>
          <% roadmap_data["roadmap"].each do |step| %>
            <div class="roadmap_step">
              <h3><%= step["time"] %> â€“ <%= step["title"] %></h3>
              <p><%= step["description"] %></p>
              <p><strong>Price:</strong> <%= step["pricing"] %></p>

              <% if step["options"].present? && step["options"].is_a?(Array) %>
                <h4>Options:</h4>
                <ul>
                  <% step["options"].each do |opt| %>
                    <li><%= opt %></li>
                  <% end %>
                </ul>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <p>Unable to display roadmap. The format is invalid.</p>
        </div>
      <% end %>
    <% rescue JSON::ParserError %>
      <div class="alert alert-danger">
        <p>Unable to parse roadmap data.</p>
      </div>
    <% end %>
  <% else %>
    <div class="alert alert-info">
      <p>No roadmap saved yet.</p>
    </div>
  <% end %>

  <% if @chats.any? %>
    <div class="division-show">
      <h2>Related Chats</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
        <% @chats.each do |chat| %>
          <%= link_to chat_path(chat), class: "button-box button-secondary button-small" do %>
            <i class="fas fa-comment-dots"></i>&nbsp; <%= chat.title %> (<%= chat.messages.count %> messages)
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0; gap: 10px; flex-wrap: wrap;">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <%= link_to plans_path, class: "button-box" do %>
        <i class="fas fa-arrow-left"></i>&nbsp; Back
      <% end %>
      <%= button_to plan_chats_path(@plan),
        method: :post,
        class: "button-box button-secondary button-icon",
        data: { turbo: false },
        form: { style: "margin: 0;" } do %>
        <i class="fas fa-comments"></i>
        <span>New Refinement Chat</span>
      <% end %>
    </div>
    <%= button_to plan_path(@plan),
      method: :delete,
      class: "button-box button-delete button-icon",
      data: { turbo_confirm: "Are you sure you want to delete this plan? All associated chats and messages will be deleted." },
      form: { style: "margin: 0;" } do %>
      <i class="fas fa-trash"></i>
      <span>Delete Plan</span>
    <% end %>
  </div>
</div>
