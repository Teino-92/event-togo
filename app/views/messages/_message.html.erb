<% if message.role == "user" || message.content.present? %>
  <div class="message <%= message.role %>" id="message_<%= message.id %>">

    <% if message.role == "user" %>
      <div class="messages-right">
        <div class="message-wrapper right">
          <%= image_tag "account.jpg", class: "avatar" %>
          <div class="message-content">
            <%= raw(render_markdown(message.content)) %>
          </div>
        </div>
      </div>

    <% else %>
      <div class="messages-left">
        <div class="message-wrapper left">
          <%= image_tag "bot.png", class: "avatar" %>
          <div class="message-content">

            <% begin %>
              <% parsed_json = JSON.parse(message.content) %>

              <% if parsed_json && parsed_json["roadmap"].is_a?(Array) %>
                <% parsed_json["roadmap"].each do |step| %>
                  <div class="roadmap-step">
                    <h3><%= step["time"] %> â€“ <%= step["title"] %></h3>
                    <p><%= step["description"] %></p>
                    <p><strong>Price:</strong> <%= step["pricing"] %></p>

                    <% if step["options"].present? && step["options"].is_a?(Array) %>
                      <ul>
                        <% step["options"].each do |opt| %>
                          <li><%= opt %></li>
                        <% end %>
                      </ul>
                    <% end %>
                  </div>
                <% end %>

              <% elsif parsed_json && parsed_json["error"] %>
                <div class="alert alert-warning">
                  <strong>Error:</strong> <%= parsed_json["error"] %>
                </div>

              <% else %>
                <%= raw(render_markdown(message.content)) %>
              <% end %>

            <% rescue JSON::ParserError %>
              <%= raw(render_markdown(message.content)) %>
            <% end %>

          </div>
        </div>
      </div>
    <% end %>

  </div>
<% end %>
